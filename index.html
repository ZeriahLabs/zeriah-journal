<script>
        // --- HELPER: Strict Date Parser (DD/MM/YYYY) ---
        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            
            try {
                // Handle "01/01/2026 00:30:00" format from cTrader
                const parts = dateStr.trim().split(' ');
                const dateParts = parts[0].split('/');
                
                // If we have Day/Month/Year components
                if (dateParts.length === 3) {
                    const day = dateParts[0].padStart(2, '0');
                    const month = dateParts[1].padStart(2, '0');
                    const year = dateParts[2];
                    const time = parts[1] || '00:00:00';
                    
                    // Construct ISO format: YYYY-MM-DDTHH:mm:ss
                    return new Date(`${year}-${month}-${day}T${time}`);
                }
                return new Date(dateStr); // Fallback
            } catch (e) {
                return null;
            }
        }

        // --- HELPER: Duration Calc ---
        function getDuration(start, end) {
            if (!start || !end || isNaN(start) || isNaN(end)) return "-";
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return `${hours}h ${mins}m`;
        }

        function clean(str) { return str ? str.replace(/['"]/g, '').trim() : ''; }

        async function loadJournal() {
            try {
                // Fetch CSV with cache busting
                const res = await fetch(CSV_URL + "&t=" + new Date().getTime()); 
                const text = await res.text();
                
                const rows = text.split('\n').map(row => row.split(','));
                
                // Update Sync Time
                const now = new Date();
                document.getElementById('last-sync').innerText = "Synced: " + now.toLocaleTimeString();

                const data = rows
                    .slice(1) // Skip Header
                    .filter(r => {
                        // FILTER: Ignore empty rows AND the "Ghost Row" (comments)
                        return r.length >= 8 && r[0] && !r[0].startsWith('//');
                    }) 
                    .map((r, i) => {
                        const openT = parseDate(clean(r[2]));
                        const closeT = parseDate(clean(r[3]));
                        
                        return {
                            id: i,
                            symbol: clean(r[0]),
                            dir: clean(r[1]),
                            openTime: openT,
                            closeTime: closeT,
                            duration: getDuration(openT, closeT),
                            entry: parseFloat(r[4]) || 0,
                            exit: parseFloat(r[5]) || 0,
                            net: parseFloat(r[8]) || 0,
                            bot: clean(r[10]) || 'Manual/Unknown',
                            pid: `TRD-${1000+i}`
                        };
                    })
                    // Filter out rows where Date failed to parse
                    .filter(t => t.openTime && !isNaN(t.openTime))
                    .sort((a,b) => b.closeTime - a.closeTime); // Newest first

                if (data.length === 0) throw new Error("No valid trades found. Check Date Format.");
                renderTable(data);
                renderStats(data);

            } catch (err) {
                console.error(err);
                document.getElementById('journal-body').innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-400 bg-red-500/10 border-l-4 border-red-500">${err.message}</td></tr>`;
            }
        }

        // ... [keep renderTable and renderStats functions exactly as they were] ...
        
        function renderTable(trades) {
            const html = trades.map(t => {
                const isWin = t.net >= 0;
                // Safe date formatting
                const openStr = t.openTime ? t.openTime.toLocaleString('en-SG', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '-';
                
                return `
                <tr class="hover:bg-white/5 transition group cursor-pointer border-l-2 border-transparent hover:border-blue-500" onclick="toggleDetails(${t.id})">
                    <td class="px-6 py-4 align-top">
                        <div class="flex flex-col">
                            <span class="text-white font-bold text-xs">${openStr}</span>
                            <span class="text-[10px] text-slate-500 mt-0.5">Dur: ${t.duration}</span>
                            <span class="text-[10px] text-blue-400 mt-2 font-bold bg-blue-500/10 px-1.5 py-0.5 rounded w-fit border border-blue-500/20">${t.bot}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <div class="flex flex-col">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-white">${t.symbol}</span>
                                <span class="text-[10px] uppercase px-1.5 py-0.5 rounded font-bold ${t.dir==='Buy'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}">${t.dir}</span>
                            </div>
                            <div class="text-xs text-slate-400 mt-2 flex items-center space-x-1">
                                <span>${t.entry.toFixed(2)}</span>
                                <span class="text-slate-600">➜</span>
                                <span class="text-white">${t.exit > 0 ? t.exit.toFixed(2) : '---'}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 align-top text-right">
                        <div class="flex flex-col items-end">
                            <span class="text-lg font-bold ${isWin ? 'text-emerald-400' : 'text-red-400'}">
                                ${isWin?'+':''}${t.net.toFixed(2)}
                            </span>
                            <span class="text-[10px] text-slate-500 mt-1">SGD</span>
                        </div>
                    </td>
                    <td class="px-2 py-4 text-center text-slate-600"><span id="arrow-${t.id}">▼</span></td>
                </tr>
                <tr id="details-${t.id}" class="hidden receipt-row">
                    <td colspan="4" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-xs">
                            <div>
                                <div class="uppercase tracking-widest text-[10px] mb-2 text-slate-500 font-bold">Identity</div>
                                <div class="grid grid-cols-2 gap-y-1">
                                    <span class="text-slate-400">ID:</span> <span class="text-white select-all font-mono">${t.pid}</span>
                                    <span class="text-slate-400">Bot:</span> <span class="text-white">${t.bot}</span>
                                </div>
                            </div>
                            <div>
                                <div class="uppercase tracking-widest text-[10px] mb-2 text-slate-500 font-bold">Timestamps</div>
                                <div class="grid grid-cols-1 gap-y-1 text-slate-400">
                                    <div>OPEN: <span class="text-slate-200">${t.openTime.toLocaleString()}</span></div>
                                    <div>CLOSE: <span class="text-slate-200">${t.closeTime.toLocaleString()}</span></div>
                                </div>
                            </div>
                             <div>
                                <div class="uppercase tracking-widest text-[10px] mb-2 text-slate-500 font-bold">Result</div>
                                <div class="grid grid-cols-2 gap-y-1">
                                     <span class="text-white font-bold border-t border-slate-700 mt-1 pt-1">Net PnL:</span> <span class="text-white font-bold border-t border-slate-700 mt-1 pt-1">${t.net.toFixed(2)} SGD</span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            document.getElementById('journal-body').innerHTML = html;
        }

        function toggleDetails(id) {
            const row = document.getElementById(`details-${id}`);
            document.getElementById(`arrow-${id}`).innerHTML = row.classList.contains('hidden') ? '▲' : '▼';
            row.classList.toggle('hidden');
        }

        function renderStats(trades) {
            const wins = trades.filter(t => t.net > 0);
            const losses = trades.filter(t => t.net <= 0);
            const totalPnL = trades.reduce((sum, t) => sum + t.net, 0);
            
            const winRate = trades.length ? ((wins.length/trades.length)*100).toFixed(1) + '%' : '-';
            const avgWin = wins.length ? (wins.reduce((a,b)=>a+b.net,0)/wins.length).toFixed(2) : '0.00';
            const avgLoss = losses.length ? (losses.reduce((a,b)=>a+b.net,0)/losses.length).toFixed(2) : '0.00';

            document.getElementById('stat-count').innerText = trades.length;
            document.getElementById('stat-winrate').innerText = winRate;
            document.getElementById('stat-avgwin').innerText = '+' + avgWin;
            document.getElementById('stat-avgloss').innerText = avgLoss;
            
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.innerText = (totalPnL>=0?'+':'') + totalPnL.toFixed(2);
            pnlEl.className = `text-xl font-mono font-bold ${totalPnL>=0?'text-emerald-400':'text-red-400'}`;
        }
        
        loadJournal();
    </script>
